---
import { Icon } from 'astro-icon/components';
---

<div class="project-filters flex flex-wrap gap-4 justify-center my-8" transition:persist>
  <button class="filter-btn active px-6 py-2 rounded-full cursor-pointer flex gap-2 items-center border border-sky-500/30 bg-slate-800/50 text-sky-400 hover:bg-sky-500/10 hover:border-sky-400 transition-all text-sm font-semibold uppercase tracking-wider" data-filter="all">
    All
  </button>
  <button class="filter-btn px-6 py-2 rounded-full cursor-pointer flex gap-2 items-center border border-sky-500/30 bg-slate-800/50 text-slate-400 hover:bg-sky-500/10 hover:text-sky-400 hover:border-sky-400 transition-all text-sm font-semibold uppercase tracking-wider" data-filter="Vue">
    <Icon name="vue" class="w-6 h-6" />
    Vue
  </button>
  <button class="filter-btn px-6 py-2 rounded-full cursor-pointer flex gap-2 items-center border border-sky-500/30 bg-slate-800/50 text-slate-400 hover:bg-sky-500/10 hover:text-sky-400 hover:border-sky-400 transition-all text-sm font-semibold uppercase tracking-wider" data-filter="React">
    <Icon name="react" class="w-6 h-6" />
    React
  </button>
  <button class="filter-btn px-6 py-2 rounded-full cursor-pointer flex gap-2 items-center border border-sky-500/30 bg-slate-800/50 text-slate-400 hover:bg-sky-500/10 hover:text-sky-400 hover:border-sky-400 transition-all text-sm font-semibold uppercase tracking-wider" data-filter="Python">
    <Icon name="python" class="w-6 h-6" />
    Python
  </button>
</div>
<div id="filter-description" class="text-center text-slate-400 max-w-2xl mx-auto my-6 min-h-[3rem] transition-all duration-300">
    <!-- Description will be injected here -->
</div>

<script>
  function setupFilters() {
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = Array.from(document.querySelectorAll('.project-card'));
    const grid = document.querySelector('#projects-grid'); // Specific Container
    
    // Store initial order
    cards.forEach((card, index) => {
             // @ts-ignore
            card.dataset.initialOrder = index;
    });

    const descriptions = {
        'all': 'Collection of recent work from real-world enterprice e-commerce to data science and automation utilities.',
        'Vue': 'Real-world enterprise e-commerce focusing Headless, Typescript, Vue 3, Nuxt, Pinia, and Tailwind',
        'React': 'Advanced explorations of the modern React 16-19 ecosystem: Next.js, Tanstack, React Query, Server Components, Redux/Zustand and performance optimization.',
        'Python': 'Automation and Data science utilities leveraging FastAPI, Flask and PyData stack (Pandas, Request, NumPy, Scikit Learn, Plotly, Seaborn and Matplotlib)'
    };

    const descContainer = document.getElementById('filter-description');
    if (descContainer) descContainer.textContent = descriptions['all'];

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        // Toggle active class
        buttons.forEach(b => {
            b.classList.remove('active', 'text-sky-400', 'border-sky-400');
            b.classList.add('text-slate-400');
        });
        btn.classList.add('active', 'text-sky-400', 'border-sky-400');
        btn.classList.remove('text-slate-400');

        const filter = btn.getAttribute('data-filter');
        // @ts-ignore
        if (descContainer) {
            descContainer.style.opacity = '0';
            setTimeout(() => {
                // @ts-ignore
                descContainer.textContent = descriptions[filter] || '';
                descContainer.style.opacity = '1';
            }, 150);
        }

        // Sorting Logic
        let sortedCards = [...cards];
        if (filter === 'all') {
            // Restore initial order
             sortedCards.sort((a, b) => {
                // @ts-ignore
                return a.dataset.initialOrder - b.dataset.initialOrder;
            });
        } else {
            // Sort by Highlight -> Weight -> Title
            sortedCards.sort((a, b) => {
                // @ts-ignore
                const highlightA = a.dataset.highlight === 'true';
                // @ts-ignore
                const highlightB = b.dataset.highlight === 'true';
                if (highlightA && !highlightB) return -1;
                if (!highlightA && highlightB) return 1;

                // @ts-ignore
                const weightA = parseInt(a.dataset.weight || '0');
                // @ts-ignore
                const weightB = parseInt(b.dataset.weight || '0');
                if (weightA !== weightB) return weightB - weightA;

                // @ts-ignore
                return a.dataset.title.localeCompare(b.dataset.title);
            });
        }

        // Re-append in new order and toggle visibility
        sortedCards.forEach(card => {
            // @ts-ignore
          const tags = JSON.parse(card.getAttribute('data-tags') || '[]');
          
          if (filter === 'all' || tags.includes(filter)) {
            // @ts-ignore
            card.style.display = 'block';
            card.animate([
              { opacity: 0, transform: 'scale(0.95)' },
              { opacity: 1, transform: 'scale(1)' }
            ], { duration: 300, easing: 'ease-out' });
          } else {
            // @ts-ignore
            card.style.display = 'none';
          }
          // @ts-ignore
          grid && grid.appendChild(card);
        });
      });
        });
  }

  // Run on load and after Astro View Transitions
  setupFilters();
  document.addEventListener('astro:page-load', setupFilters);
</script>

<style>
    .filter-btn.active {
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
    }
</style>
